---
name: Полная бизнес-логика и безопасность
overview: Обновление цен, исправление логики доступности мест, добавление отмены/возврата, настройка безопасности, мониторинга, email уведомлений через TimeWeb SMTP и кросс-браузерное тестирование.
todos:
  - id: update-prices
    content: "Обновить цены: Стандарт 600, Комфорт 800, Комфорт+ 900, Женский 800"
    status: completed
  - id: fix-availability
    content: Исправить логику доступности мест (считать гостей, не номера)
    status: completed
    dependencies:
      - update-prices
  - id: booking-cancel
    content: Добавить API отмены бронирования с возвратом через ЮKassa
    status: completed
    dependencies:
      - fix-availability
  - id: rate-limiting
    content: Добавить rate limiting через middleware
    status: completed
  - id: security-headers
    content: Добавить security headers в next.config.js
    status: completed
  - id: honeypot
    content: Добавить honeypot поля в формы
    status: completed
  - id: smtp-email
    content: Настроить nodemailer для SMTP TimeWeb
    status: completed
  - id: email-template
    content: Обновить шаблон письма с реальными данными
    status: completed
    dependencies:
      - smtp-email
  - id: sentry
    content: Настроить Sentry для мониторинга ошибок
    status: completed
  - id: health-check
    content: Создать /api/health endpoint
    status: completed
  - id: yandex-metrika
    content: Добавить Яндекс.Метрику
    status: completed
  - id: error-pages
    content: Создать страницы 404 и 500
    status: completed
  - id: cross-browser
    content: Настроить кросс-браузерные тесты Playwright
    status: completed
---

# Комплексный план доработки хостела DELAS

## Часть 1: Бизнес-логика (КРИТИЧНО)

### 1.1 Обновление цен номеров

**Новые цены:**| Номер | Места | Цена ||-------|-------|------|| Стандарт | 10 | 600 руб || Комфорт | 8 | 800 руб || Комфорт+ | 6 | 900 руб || Женский Комфорт+ | 4 | **800 руб** (было 1000) |**Файлы для изменения:**

- [`src/constants/hotel.ts`](src/constants/hotel.ts) - основные константы
- [`prisma/seed.ts`](prisma/seed.ts) - данные для БД
- Тесты в `src/__tests__/` - обновить ожидаемые значения

### 1.2 Исправление логики "Нет свободных мест"

**Проблема:** Текущая логика проверяет `overlappingBookings >= roomType.totalUnits`, где `totalUnits` = количество номеров (например, 2), но бронируют **койко-места** (10 в номере).**Решение:** Изменить логику на подсчёт **забронированных гостей** vs **общее количество мест**:

```typescript
// Текущая логика (НЕВЕРНО):
if (overlappingBookings >= roomType.totalUnits) // 1 бронь >= 2 номеров = false

// Новая логика (ВЕРНО):
const totalBeds = roomType.beds * roomType.totalUnits // 10 * 2 = 20 мест
const bookedGuests = await prisma.booking.aggregate({
  where: { ... overlapping conditions ... },
  _sum: { guestsCount: true }
})
if (bookedGuests._sum.guestsCount + newGuestsCount > totalBeds) {
  return "Нет свободных мест"
}
```

**Файлы:**

- [`src/app/api/booking/route.ts`](src/app/api/booking/route.ts)
- [`src/app/api/rooms/availability/route.ts`](src/app/api/rooms/availability/route.ts)

### 1.3 Отмена бронирования с возвратом денег

**Новые API endpoints:**

- `POST /api/booking/cancel` - отмена бронирования
- Интеграция с ЮKassa Refunds API

**Правила отмены (согласно `/terms`):**

- За 24+ часов до заезда = 100% возврат
- Менее 24 часов = возврат минус 1 сутки

**Файлы для создания:**

- `src/app/api/booking/cancel/route.ts`
- Обновить [`src/lib/yookassa.ts`](src/lib/yookassa.ts) - добавить `createRefund()`

---

## Часть 2: Безопасность

### 2.1 Rate Limiting

Добавить ограничение запросов к API:

- `/api/booking` - макс 5 запросов/минуту с одного IP
- `/api/corporate` - макс 3 запросов/минуту
- `/api/payment/*` - макс 10 запросов/минуту

**Реализация:** Через Vercel Edge или middleware с in-memory store**Файл:** `src/middleware.ts` (создать)

### 2.2 Security Headers

Добавить в [`next.config.js`](next.config.js):

```javascript
headers: [
  {
    source: '/:path*',
    headers: [
      { key: 'X-Frame-Options', value: 'DENY' },
      { key: 'X-Content-Type-Options', value: 'nosniff' },
      { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
      { key: 'X-XSS-Protection', value: '1; mode=block' },
    ]
  }
]
```



### 2.3 Honeypot поля (защита от ботов)

Добавить скрытое поле в формы бронирования и корпоративных заявок.---

## Часть 3: Мониторинг

### 3.1 Sentry (отслеживание ошибок)

```bash
npm install @sentry/nextjs
```

**Файлы:**

- `sentry.client.config.ts`
- `sentry.server.config.ts`
- `sentry.edge.config.ts`
- Обновить [`next.config.js`](next.config.js)

### 3.2 Health Check Endpoint

**Файл:** `src/app/api/health/route.ts`

```typescript
export async function GET() {
  const dbOk = await prisma.$queryRaw`SELECT 1`
  return Response.json({
    status: 'ok',
    database: dbOk ? 'connected' : 'error',
    timestamp: new Date().toISOString()
  })
}
```



### 3.3 Яндекс.Метрика

Добавить счётчик в [`src/app/layout.tsx`](src/app/layout.tsx)---

## Часть 4: Email через TimeWeb SMTP

### 4.1 Настройка SMTP

TimeWeb Cloud SMTP настройки:

- **Host:** smtp.timeweb.ru
- **Port:** 465 (SSL) или 587 (TLS)
- **User:** info@hostel-delas.ru
- **Password:** (ваш пароль от почты)

### 4.2 Переписать [`src/lib/email.ts`](src/lib/email.ts)

Заменить Resend на nodemailer:

```typescript
import nodemailer from 'nodemailer'

const transporter = nodemailer.createTransport({
  host: process.env.SMTP_HOST,
  port: Number(process.env.SMTP_PORT),
  secure: true,
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASSWORD,
  },
})
```



### 4.3 Обновить шаблон письма

- Заменить `+7 (XXX) XXX-XX-XX` на реальный номер
- Добавить WhatsApp ссылку
- Добавить кнопку "Отменить бронирование"

---

## Часть 5: Кросс-браузерное тестирование

### 5.1 Playwright проекты

Обновить [`playwright.config.ts`](playwright.config.ts):

```typescript
projects: [
  { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
  { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
  { name: 'webkit', use: { ...devices['Desktop Safari'] } },
  { name: 'edge', use: { channel: 'msedge' } },
  { name: 'mobile-chrome', use: { ...devices['Pixel 5'] } },
  { name: 'mobile-safari', use: { ...devices['iPhone 13'] } },
]
```



### 5.2 Тесты визуальной регрессии

Добавить скриншот-тесты для ключевых страниц.---

## Часть 6: Дополнительное

### 6.1 Страницы ошибок

- `src/app/not-found.tsx` - 404
- `src/app/error.tsx` - 500

### 6.2 Обновить USER_DATA.md

Отметить заполненные цены.---

## Порядок выполнения

```javascript
1. Цены и бизнес-логика    [КРИТИЧНО]
   ├── Обновить цены
   ├── Исправить логику доступности
   └── Добавить отмену/возврат

2. Безопасность            [ВАЖНО]
   ├── Rate limiting
   ├── Security headers
   └── Honeypot

3. Email через SMTP        [ВАЖНО]
   ├── nodemailer настройка
   └── Шаблон письма

4. Мониторинг             [ЖЕЛАТЕЛЬНО]
   ├── Sentry
   ├── Health check
   └── Яндекс.Метрика

5. Тестирование           [ЖЕЛАТЕЛЬНО]
   ├── Кросс-браузерные тесты
   └── Визуальная регрессия
```

---

## Зависимости для установки

```bash
npm install nodemailer @sentry/nextjs
npm install -D @types/nodemailer
```



## Переменные окружения

```env
# SMTP (TimeWeb)
SMTP_HOST=smtp.timeweb.ru
SMTP_PORT=465
SMTP_USER=info@hostel-delas.ru
SMTP_PASSWORD=ваш_пароль

# Sentry
SENTRY_DSN=https://xxx@sentry.io/xxx

# Яндекс.Метрика
NEXT_PUBLIC_YM_ID=12345678


```